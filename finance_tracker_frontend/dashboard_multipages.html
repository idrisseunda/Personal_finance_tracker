<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINA-Personal Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            background-image: url('background.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
        }

        .view-section {
            transition: all 0.3s ease-in-out;
        }

        .hidden {
            display: none !important; /* Used to hide/show pages */
        }

        /* Glassmorphism effect for cards (Semi-transparent white) */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <script>
        // Check authentication FIRST - before anything else loads
        (function() {
            const user = localStorage.getItem('currentUser');
            const token = localStorage.getItem('token');
            if (!user || !token) {
                window.location.replace('index.html');
            }
        })();
    </script>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header with Logout -->
        <header class="mb-8 bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <img src="AIMS_logo.png" alt="AIMS Logo" class="h-16 w-16 object-contain">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-800 mb-2">üí∞ FINA-Personal Finance Tracker</h1>
                        <p class="text-gray-600">Track your income, expenses, savings, and investments</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="userNameDisplay" class="font-bold text-gray-700">User</span>
                    <button onclick="logout()" class="text-red-500 hover:text-red-700 font-bold">Logout</button>
                </div>
             </div>
        </header>

        <section id="view-overview" class="view-section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="glass-card p-6 rounded-2xl shadow-lg border-b-4 border-indigo-500">
                    <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Net Balance</p>
                    <h3 id="balance" class="text-3xl font-black text-gray-800">$0.00</h3>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-lg border-b-4 border-green-500">
                    <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Total Income</p>
                    <h3 id="totalIncome" class="text-3xl font-black text-green-600">$0.00</h3>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-lg border-b-4 border-red-500">
                    <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Total Expenses</p>
                    <h3 id="totalExpense" class="text-3xl font-black text-red-600">$0.00</h3>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-lg border-b-4 border-purple-500">
                    <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Savings/Inv</p>
                    <h3 id="totalSavings" class="text-3xl font-black text-purple-600">$0.00</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <button onclick="showView('analytics')" class="p-10 bg-white hover:bg-indigo-50 rounded-3xl shadow-xl transition-all transform hover:-translate-y-2 text-left">
                    <span class="text-5xl block mb-4">üìä</span>
                    <h3 class="text-2xl font-bold text-gray-800">Visual Analytics</h3>
                    <p class="text-gray-500">Deep dive into trends, category splits, and histograms.</p>
                </button>
                <button onclick="showView('history')" class="p-10 bg-white hover:bg-purple-50 rounded-3xl shadow-xl transition-all transform hover:-translate-y-2 text-left">
                    <span class="text-5xl block mb-4">üìú</span>
                    <h3 class="text-2xl font-bold text-gray-800">Transaction History</h3>
                    <p class="text-gray-500">Search, filter, and manage your full entry history.</p>
                </button>
            </div>

            <div class="text-center">
                <button onclick="toggleAddForm()" class="bg-indigo-600 text-white px-10 py-4 rounded-full font-bold shadow-2xl hover:bg-indigo-700 hover:scale-105 transition-all">
                    ‚ûï Add New Transaction
                </button>
            </div>
        </section>

        <section id="view-analytics" class="view-section hidden">
            <div class="flex justify-between items-center mb-8 bg-white/30 p-4 rounded-xl">
                <button onclick="showView('overview')" class="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold shadow">‚Üê Home</button>
                <select id="analyticsFilter" onchange="updateDashboard()" class="p-2 rounded-lg bg-white font-bold shadow cursor-pointer">
                    <option value="daily">Today</option>
                    <option value="weekly">This Week</option>
                    <option value="monthly" selected>This Month</option>
                    <option value="yearly">This Year</option>
                </select>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="font-bold text-gray-700 mb-4">Flow Trend (Line)</h3>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="font-bold text-gray-700 mb-4">Volume Comparison (Histogram)</h3>
                    <canvas id="trendBarChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="font-bold text-gray-700 mb-4">Income Sources</h3>
                    <canvas id="incomeBarChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="font-bold text-gray-700 mb-4">Expense Categories</h3>
                    <canvas id="expenseBarChart"></canvas>
                </div>
            </div>
        </section>

        <section id="view-history" class="view-section hidden">
            <div class="flex justify-between items-center mb-8 bg-white/30 p-4 rounded-xl">
                <button onclick="showView('overview')" class="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold shadow">‚Üê Home</button>
                <select id="historyFilter" onchange="updateDashboard()" class="p-2 rounded-lg bg-white font-bold shadow cursor-pointer">
                    <option value="daily">Today</option>
                    <option value="weekly">This Week</option>
                    <option value="monthly" selected>This Month</option>
                    <option value="yearly">This Year</option>
                </select>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden overflow-x-auto">
                <table class="w-full text-left min-w-[600px]">
                    <thead class="bg-gray-100 border-b-2">
                        <tr>
                            <th class="p-4 font-bold text-gray-600">Date</th>
                            <th class="p-4 font-bold text-gray-600">Type</th>
                            <th class="p-4 font-bold text-gray-600">Category</th>
                            <th class="p-4 font-bold text-gray-600 text-right">Amount</th>
                            <th class="p-4 font-bold text-gray-600 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTable" class="divide-y">
                        </tbody>
                </table>
            </div>
        </section>

        <footer class="mt-20 py-10 text-center border-t border-white/20">
            <div class="opacity-60 grayscale hover:grayscale-0 transition-all cursor-default group">
                <span class="text-4xl group-hover:scale-110 transition-transform inline-block">üí∞</span>
                <h2 class="text-2xl font-black text-white tracking-widest">FINA</h2>
                <p class="text-white text-[10px] uppercase font-bold tracking-widest mt-1">Your Personal Finance Navigator</p>
            </div>
        </footer>
    </div>

    <div id="addForm" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden px-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full relative">
            <button onclick="toggleAddForm()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <h2 class="text-2xl font-bold mb-6 text-indigo-700">Add Transaction</h2>
            <form id="transactionForm" onsubmit="event.preventDefault(); addTransaction();" class="space-y-4">
                 <input type="text" id="desc" placeholder="Description" class="w-full p-3 border rounded-xl" required>
                 <select id="type" class="w-full p-3 border rounded-xl" required>
                     <option value="income">Income</option>
                     <option value="expense">Expense</option>
                     <option value="savings">Savings/Investment</option>
                 </select>
                 <input type="text" id="category" placeholder="Category" class="w-full p-3 border rounded-xl" required>
                 <input type="number" id="amount" placeholder="Amount" step="0.01" class="w-full p-3 border rounded-xl" required>
                 <input type="date" id="date" class="w-full p-3 border rounded-xl" required>
                 <button type="submit" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-lg">Save Transaction</button>
            </form>
        </div>
    </div>

    <script>
        let transactions = []; // Main data array
        let charts = {};       // Chart object storage
        let currentView = 'overview';

        // 1. NAVIGATION: Handles hiding/showing "pages"
        function showView(viewName) {
            currentView = viewName;
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            updateDashboard(); // Refresh data for the specific page
            window.scrollTo(0,0);
        }

        // 2. DATA LOADING: Fetches from your Flask backend
        async function loadTransactions() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('http://127.0.0.1:5000/api/transactions', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    transactions = await response.json();
                    updateDashboard();
                }
            } catch (error) { console.error("Fetch Error:", error); }
        }

        // 3. FILTERING: Strict logic for Daily, Weekly, Monthly, Yearly
        function filterTransactionsByTime() {
            const filterEl = (currentView === 'analytics') ? 
                             document.getElementById('analyticsFilter') : 
                             document.getElementById('historyFilter');
            
            const filter = filterEl ? filterEl.value : 'monthly';
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            return transactions.filter(t => {
                const parts = t.date.split('-');
                const tDate = new Date(parts[0], parts[1]-1, parts[2]);

                switch(filter) {
                    case 'daily': 
                        return tDate.getTime() === today.getTime();
                    case 'weekly':
                        const day = today.getDay();
                        const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                        const mon = new Date(now.getFullYear(), now.getMonth(), diff);
                        const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
                        return tDate >= mon && tDate <= sun;
                    case 'monthly':
                        return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                    case 'yearly':
                        return tDate.getFullYear() === now.getFullYear();
                    default: return true;
                }
            });
        }

        // 4. MAIN UPDATE: Updates text and charts
        function updateDashboard() {
            const filtered = filterTransactionsByTime();
            
            // Calculate Summary Totals
            const inc = filtered.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            const exp = filtered.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            const sav = filtered.filter(t => t.type === 'savings').reduce((s,t) => s + t.amount, 0);

            // Update Text UI
            document.getElementById('totalIncome').innerText = 'F' + inc.toFixed(2);
            document.getElementById('totalExpense').innerText = 'F' + exp.toFixed(2);
            document.getElementById('totalSavings').innerText = 'F' + sav.toFixed(2);
            document.getElementById('balance').innerText = 'F' + (inc - exp - sav).toFixed(2);

            // Only render charts if on Analytics page
            if (currentView === 'analytics') {
                updateTrendLine(filtered);
                updateTrendHistogram(filtered);
                updateCategoryBars(filtered, 'income', 'incomeBarChart');
                updateCategoryBars(filtered, 'expense', 'expenseBarChart');
            }
            
            // Only render table if on History page
            if (currentView === 'history') {
                renderTable(filtered);
            }
        }

        /* --- CHART RENDERING HELPERS --- */

        function updateTrendLine(filtered) {
            const dataMap = {};
            filtered.forEach(t => {
                if(!dataMap[t.date]) dataMap[t.date] = {i:0, e:0};
                if(t.type === 'income') dataMap[t.date].i += t.amount;
                if(t.type === 'expense') dataMap[t.date].e += t.amount;
            });
            const labels = Object.keys(dataMap).sort();
            
            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Income', data: labels.map(l => dataMap[l].i), borderColor: '#10B981', tension: 0.4 },
                        { label: 'Expense', data: labels.map(l => dataMap[l].e), borderColor: '#EF4444', tension: 0.4 }
                    ]
                }
            });
        }

        function updateTrendHistogram(filtered) {
            const dataMap = {};
            filtered.forEach(t => {
                if(!dataMap[t.date]) dataMap[t.date] = {i:0, e:0};
                if(t.type === 'income') dataMap[t.date].i += t.amount;
                if(t.type === 'expense') dataMap[t.date].e += t.amount;
            });
            const labels = Object.keys(dataMap).sort();
            
            if (charts.hist) charts.hist.destroy();
            charts.hist = new Chart(document.getElementById('trendBarChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Income', data: labels.map(l => dataMap[l].i), backgroundColor: '#10B981' },
                        { label: 'Expense', data: labels.map(l => dataMap[l].e), backgroundColor: '#EF4444' }
                    ]
                }
            });
        }

        function updateCategoryBars(filtered, type, canvasId) {
            const catMap = {};
            filtered.filter(t => t.type === type).forEach(t => {
                catMap[t.category] = (catMap[t.category] || 0) + t.amount;
            });
            
            if (charts[canvasId]) charts[canvasId].destroy();
            charts[canvasId] = new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: {
                    labels: Object.keys(catMap),
                    datasets: [{ label: type.toUpperCase(), data: Object.values(catMap), backgroundColor: type === 'income' ? '#10B981' : '#EF4444' }]
                },
                options: { indexAxis: 'y' } // Makes it a horizontal bar
            });
        }

        /* --- TABLE & FORM HELPERS --- */

        function renderTable(filtered) {
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = filtered.map(t => `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 text-sm">${t.date}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${t.type==='income'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${t.type}</span></td>
                    <td class="p-4 text-sm">${t.category}</td>
                    <td class="p-4 text-right font-bold">F${t.amount.toFixed(2)}</td>
                    <td class="p-4 text-center">
                        <button onclick="deleteTransaction(${t.id})" class="text-red-400 hover:text-red-600">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleAddForm() {
            document.getElementById('addForm').classList.toggle('hidden');
        }

        async function addTransaction() {
            const data = {
                description: document.getElementById('desc').value,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('date').value
            };
            const token = localStorage.getItem('token');
            const res = await fetch('http://127.0.0.1:5000/api/transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                toggleAddForm();
                loadTransactions();
            }
        }

        async function deleteTransaction(id) {
            if(!confirm("Delete this record?")) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`http://127.0.0.1:5000/api/transactions/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) loadTransactions();
        }

        function logout() {
            localStorage.clear();
            window.location.replace('index.html');
        }

        // Initialize user display and load data
        window.onload = () => {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            document.getElementById('userNameDisplay').innerText = user.username || 'User';
            loadTransactions();
        };
    </script>
</body>
</html>